<div class="table-container">
  <!-- Título de la tabla -->
  <h3 *ngIf="titulo" class="tabla-titulo">
    {{ titulo }}
    <span class="tabla-subtitulo" *ngIf="subtitulo">({{ subtitulo }})</span>
  </h3>
  
  <div class="table-responsive">
    <!-- Loader mientras carga -->
    <div class="table-loader" *ngIf="cargando">
      <app-loader-puntos></app-loader-puntos>
      <p class="loader-text">Cargando...</p>
    </div>

    <!-- Tabla con datos -->
    <table class="table" *ngIf="!cargando && datos && datos.length > 0">
      <thead>
        <tr>
          <th class="expand-column" *ngIf="expandible"></th>
          <th 
            *ngFor="let columna of columnas" 
            [class]="obtenerClaseAlineacion(columna.alineacion)"
            [style.width]="columna.ancho">
            {{ columna.label }}
          </th>
          <th *ngIf="accion" class="acciones-column">Acciones</th>
        </tr>
      </thead>
      <tbody>
        <ng-container *ngFor="let item of datos; let i = index">
          <!-- Fila principal -->
          <tr class="main-row" [class.expanded]="isFilaExpandida(i)">
            <td class="expand-column" *ngIf="expandible">
              <button 
                type="button"
                class="expand-button"
                [class.active]="isFilaExpandida(i)"
                (click)="toggleFilaExpandida(i, item)"
                title="Ver detalles">
                <span class="expand-icon">{{ isFilaExpandida(i) ? '-' : '+' }}</span>
              </button>
            </td>
            <td 
              *ngFor="let columna of columnas" 
              [class]="obtenerClaseAlineacion(columna.alineacion)">
              <ng-container [ngSwitch]="columna.tipo">
                <span *ngSwitchCase="'custom'">
                  <ng-content [select]="'[slot=' + columna.key + ']'"></ng-content>
                </span>
                <span *ngSwitchDefault>
                  {{ formatearValor(obtenerValorCelda(item, columna), columna.tipo) }}
                </span>
              </ng-container>
            </td>
            <td *ngIf="accion" class="acciones-column">
              <button 
                *ngIf="deberiaMostrarAccion(item)"
                type="button"
                class="btn-accion"
                [class]="accion.clase"
                (click)="onAccionClick(item)">
                <img *ngIf="accion.icono" [src]="accion.icono" [alt]="accion.texto" class="accion-icon">
                <span>{{ accion.texto }}</span>
              </button>
            </td>
          </tr>

          <!-- Fila expandida -->
          <tr class="expanded-row" *ngIf="expandible && isFilaExpandida(i)">
            <td [attr.colspan]="obtenerColspan()" class="expanded-content">
              <ng-container *ngIf="plantillaExpandida; else defaultExpanded">
                <ng-container 
                  *ngTemplateOutlet="plantillaExpandida; context: { $implicit: item, index: i }">
                </ng-container>
              </ng-container>
              
              <!-- Template por defecto para contenido expandido -->
              <ng-template #defaultExpanded>
                <div class="detalle-expandido">
                  <!-- Información adicional -->
                  <div class="detalle-grid" *ngIf="datosExpandidos">
                    <ng-container *ngFor="let dato of datosExpandidos(item) | keyvalue">
                      <div class="detalle-item">
                        <span class="detalle-label">{{ dato.key }}</span>
                        <span class="detalle-value">{{ dato.value || 'N/A' }}</span>
                      </div>
                    </ng-container>
                  </div>

                  <!-- Subtabla -->
                  <div *ngIf="plantillaSubtabla">
                    <ng-container 
                      *ngTemplateOutlet="plantillaSubtabla; context: { $implicit: item, index: i }">
                    </ng-container>
                  </div>
                </div>
              </ng-template>
            </td>
          </tr>
        </ng-container>
      </tbody>
      
      <!-- Pie de tabla (totales) -->
      <tfoot *ngIf="mostrarPieTabla && pieTabla">
        <tr class="pie-tabla">
          <td *ngIf="expandible" class="expand-column"></td>
          <td 
            *ngFor="let columna of columnas; let first = first" 
            [class]="obtenerClaseAlineacion(columna.alineacion)">
            <strong *ngIf="first">TOTALES</strong>
            <strong *ngIf="!first && pieTabla[columna.key]">{{ pieTabla[columna.key] }}</strong>
          </td>
          <td *ngIf="accion" class="acciones-column"></td>
        </tr>
      </tfoot>
    </table>

    <!-- Sin datos -->
    <div class="no-data" *ngIf="!cargando && (!datos || datos.length === 0)">
      <p>{{ sinDatosMensaje }}</p>
    </div>
  </div>
</div>